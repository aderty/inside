"use strict";(function(){this.register("ActiviteAdmin",["$scope","$rootScope","$dialog","$timeout","$compile","$filter","ngTableParams","ngTableFilter","ActiviteAdminService",b]);this.register("DialogShowActivite",["$scope","$rootScope","$timeout","$compile","dialog","ActiviteAdminService",a]);function b(m,l,e,f,g,j,d,i,c){var h=new Date().getFullYear();m.lstAnnees=[h,h-1,h-2];m.lstMois=[];m.lstMois.push.apply(m.lstMois,jQuery.fullCalendar.monthNames);m.lstMois.splice(0,0,"Tous");m.selection={annee:h,mois:m.lstMois[new Date().getMonth()+1]};m.$on("search",function(n,o){if(o.searcher=="admin-activite"){m.tableParamsActivite.$params.filter=o.search;m.tableParamsSansActivite.$params.filter=o.search}});l.tableParamsActivite=new d({page:1,count:10,sorting:{mois:"asc"}},{getData:function(o,p){var n=angular.copy(m.selection);n.mois=m.lstMois.indexOf(n.mois);c.list(n).then(function(q){l.activites=i(q,p);o.resolve(l.activites)})}});l.tableParamsSansActivite=new d({page:1,count:10,sorting:{mois:"asc"}},{getData:function(o,p){var n=angular.copy(m.selection);n.mois=m.lstMois.indexOf(n.mois);c.listSans(n).then(function(q){l.sansActivites=i(q,p);o.resolve(l.sansActivites)})}});m.$watch("selection",function(o){var n=angular.copy(o);n.mois=m.lstMois.indexOf(o.mois);l.tableParamsActivite.reload();l.tableParamsSansActivite.reload()},true);m.isEditable=function(n){return true};m.valider=function(q){var p=angular.copy(q);var o=[{label:"Oui",result:"yes",cssClass:"btn-primary"},{label:"Non",result:"no"}];var n=e.messageBox("Validation d'un mois d'activité","Etes-vous sûr de valider l'activité de "+p.user.prenom+" du mois de "+moment(p.mois).format("MMMM YYYY")+" ?",o);n.open().then(function(r){if(r==="yes"){p.etat=2;c.updateEtat(p).then(function(s){if(s.success){q.etat=p.etat;l.infos.nbActivitesVal--}})}})};m.opts={backdrop:true,keyboard:true,backdropClick:true,template:$.trim($("#showActiviteTmpl").html()),controller:"DialogShowActivite"};m.visualiser=function(n){m.currentActivite=angular.copy(n);c.get(m.currentActivite).then(function(q){l.error="";m.eventSources=null;m.activiteUser=[];if(q.activite.length>0){for(var p=0,o=q.activite.length;p<o;p++){m.activiteUser.push({title:q.activite[p].type,start:q.activite[p].jour.date,data:q.activite[p]})}}if(!m.eventSources){m.eventSources=[m.activiteUser]}l.currentActivite=m.currentActivite;l.eventSources=m.eventSources;var r=e.dialog(m.opts);r.open().then(function(s){if(s){}})})};m["delete"]=function(q){var p=angular.copy(q);var o=[{label:"Oui",result:"yes",cssClass:"btn-primary"},{label:"Non",result:"no"}];var n=e.messageBox("Suppression d'un mois d'activité","Etes-vous sûr de supprimer l'activité de "+p.user.prenom+" du mois de "+moment(p.mois).format("MMMM YYYY")+" ?",o);n.open().then(function(r){if(r==="yes"){c.remove(p).then(function(t){if(t.success){var s=l.activites.indexOf(q);l.activites.splice(s,1);l.infos.nbActivitesVal--}})}})};function k(n){return n.format("d")!=0&&n.format("d")!=6}m.create=function(n){l.currentActivite=angular.copy(n);l.currentActivite.mois.setHours(12);m.start=l.currentActivite.mois;m.start.setHours(0);c.get(l.currentActivite).then(function(A){m.indexEvents=[];l.error="";m.activite=A;m.eventSources=null;m.activiteUser=[];m.events=[];function p(F,D){q=true;var B=true;if(k(F)&&!D){var E=angular.copy(w);E.start=true;if(E.fin.date.getMonth()<=F.month()&&E.fin.date.getDate()<=F.date()){E.end=true}if(!E.end&&E.debut.type==0){E.duree=0}else{if(!E.end&&E.debut.type==1){E.duree=2;var C=new Date(F.toDate());C.setHours(8);if(s.fin.date.getMonth()==F.month()&&E.fin.date.getDate()<F.date()){m.events.push({title:"Journée travaillée",allDay:false,start:C,data:{type:"JT1",duree:1,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}})}C=new Date(F.toDate());C.setHours(12);m.events.push({title:j("motifCongesShort")(E.type),start:C,data:E,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0});m.indexEvents[F.date()]=m.events.length-1;B=false}else{if(E.debut.type==0&&E.end&&E.fin.type==0){E.duree=1;var C=new Date(F.toDate());C.setHours(8);m.events.push({title:j("motifCongesShort")(E.type),start:C,data:E,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0});C=new Date(F.toDate());C.setHours(12);if(m.conges.length>0&&m.conges[0].fin.date.getMonth()==F.month()&&m.conges[0].fin.date.getDate()<F.date()){m.events.push({title:"Journée travaillée",allDay:false,start:C,data:{type:"JT1",duree:2,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}})}B=false}else{if(E.debut.type==1&&E.end&&E.fin.type==1){E.duree=2;var C=new Date(F.toDate());C.setHours(8);if(s.fin.date.getMonth()==F.month()&&E.fin.date.getDate()<F.date()){m.events.push({title:"Journée travaillée",allDay:false,start:C,data:{type:"JT1",duree:1,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}})}C=new Date(F.toDate());C.setHours(12);m.events.push({title:j("motifCongesShort")(E.type),start:C,data:E,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0});m.indexEvents[F.date()]=m.events.length-1;B=false}else{if(E.debut.type==0&&E.end&&E.fin.type==1){E.duree=0}}}}}if(B){if(E.type=="JF"&&m.indexEvents[F.date()]&&m.events[m.indexEvents[F.date()]]){m.events.splice(m.indexEvents[F.date()],1)}E.heuresSup=0;E.heuresAstreinte=0;E.heuresNuit=0;E.heuresInt=0;m.events.push({title:j("motifCongesShort")(E.type),start:new Date(F.toDate()),data:E});m.indexEvents[F.date()]=m.events.length-1}}if(!s||s.fin.date.getDate()<=F.date()){s=angular.copy(w)}w=m.conges.shift()}function v(E){var D=angular.copy(s);var B=true;if(D.fin.date.getMonth()<=E.month()&&D.fin.date.getDate()<=E.date()){D.end=true}if(!D.end){D.duree=0}if(D.end&&D.fin.type==0){D.duree=1;var C=new Date(E.toDate());C.setHours(8);D.heuresSup=0;D.heuresAstreinte=0;D.heuresNuit=0;D.heuresInt=0;m.events.push({title:j("motifCongesShort")(D.type),start:C,data:D});m.indexEvents[E.date()]=m.events.length-1;C=new Date(E.toDate());C.setHours(12);if(w&&w.fin.date.getMonth()==E.month()&&w.fin.date.getDate()<E.date()){m.events.push({title:"Journée travaillée",allDay:false,start:C,data:{type:"JT1",duree:2,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}})}B=false}if(D.end&&D.fin.type==1){D.duree=0}if(B){D.duree=0;D.heuresSup=0;D.heuresAstreinte=0;D.heuresNuit=0;D.heuresInt=0;m.events.push({title:j("motifCongesShort")(D.type),start:new Date(E.toDate()),data:D});m.indexEvents[E.date()]=m.events.length-1}}function z(B){q=false}function o(B){if(k(B)){m.events.push({title:"Journée travaillée",start:new Date(B.toDate()),data:{type:"JT1",duree:0,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}})}else{m.events.push({title:"Weekend",start:new Date(B.toDate()),data:{type:"WK",duree:0,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}})}m.indexEvents[B.date()]=m.events.length-1}if(m.activite.etat>0&&m.activite.activite.length>0){for(var t=0,r=m.activite.activite.length;t<r;t++){m.events.push({title:m.activite.activite[t].type,start:m.activite.activite[t].jour.date,data:m.activite.activite[t]});m.indexEvents[m.activite.activite[t].jour.date]=m.events.length-1}}else{m.conges=m.activite.activite;var w=m.conges.shift();var s;var u=true;var q=false;var x=new moment(m.start);if(x.date()!=1){while(x.date()!=1){if(w&&w.debut.date.getMonth()==x.month()&&w.debut.date.getDate()==x.date()){p(x,true)}if(q&&s&&s.fin.date<=x.toDate()){z(x)}x=x.add("days",1)}}while(x.date()!=1||u){u=false;if(q&&k(x)){v(x)}if(w&&w.debut.date.getMonth()==x.month()&&w.debut.date.getDate()==x.date()){p(x)}if(q&&s&&s.fin.date.getMonth()<=x.month()&&s.fin.date.getDate()<=x.date()){z(x)}if(typeof m.indexEvents[x.date()]=="undefined"){o(x)}x=x.add("days",1)}}if(!m.eventSources){m.eventSources=[m.events]}l.eventSources=m.eventSources;var y=e.dialog(m.opts);y.open().then(function(C){if(C){var B=l.activites.indexOf(n);l.sansActivites.splice(B,1);l.infos.nbActivitesVal++;l.activites.push(C)}})})}}function a(d,c,h,g,f,i){c.error="";d.user=d.$parent.currentActivite.user;d.eventSources=d.$parent.eventSources;d.uiConfig=d.$parent.uiConfig;d.close=function(){c.error="";f.close()};var e=new Date().getFullYear();d.activiteUser=[];d.alertEventOnClick=function(l,m,k,j){d.$apply(function(){d.eventSelectionne=new moment(l).format("dddd D MMMM YYYY")})};d.eventOnClick=function(l,k,j){d.$apply(function(){d.currentEvent=l.data;d.eventSelectionne=new moment(l.start).format("dddd D MMMM YYYY")})};d.eventRender=function(k,j){function m(p){var o=0,n=d.eventSources[0].length;for(;o<n;o++){if(d.eventSources[0][o].start==p){return o}}return -1}var l=d.$new(true);angular.extend(l,k);l.typeActivite=c.typeActivite;l.typeActiviteJour=c.typeActivite;l.valid=function(p){l.error=null;$("[rel=popover]").popover("hide");var q=l.savedEvent.duree;if(this.data.duree==q){return}if(this.data.duree==1){var o=new Date(this.start);o.setHours(16);this.start.setHours(8);this.allDay=false;d.isUpdating=true;var n=m(this.start);d.eventSources[0].splice(n+1,0,{title:"Ap. midi",start:o,allDay:false,data:{type:this.data.type,jour:o,duree:2}});d.activiteCalendar.fullCalendar("refetchEvents")}else{if(this.data.duree==2){var o=new Date(this.start);o.setHours(8);this.start.setHours(16);this.allDay=false;d.isUpdating=true;var n=m(this.start);d.eventSources[0].splice(n,0,{title:"Matin",start:o,allDay:false,data:{type:this.data.type,jour:o,duree:1}});d.activiteCalendar.fullCalendar("refetchEvents")}else{if(this.data.duree==0&&q==1){this.allDay=true;d.isUpdating=true;var n=m(this.start);this.start.setHours(0);d.eventSources[0].splice(n+1,1);d.activiteCalendar.fullCalendar("refetchEvents")}else{if(this.data.duree==0&&q==2){this.allDay=true;d.isUpdating=true;var n=m(this.start);this.start.setHours(0);d.eventSources[0].splice(n-1,1);d.activiteCalendar.fullCalendar("refetchEvents")}}}}};l.cancel=function(n){l.error=null;$.extend(l.data,l.savedEvent);$("[rel=popover]").popover("hide")};l.infos=function(n){if(n.duree==2){return"Ap. midi"}if(n.duree==1){return"Matin"}};l.hasHeuresAstreinte=function(n){return true};l.$watch("data.type",function(o,n){if(n&&o=="JT1"&&(n=="WK"||n=="JF")){l.data.heuresAstreinte=7.5}});return g($.trim($("#eventTmpl").html()))(l).attr("rel","popover").popover({html:true,content:function(n){l.savedEvent=angular.copy(l.data);return g($.trim($("#popoverEventTmpl").html()))(l)}}).click(function(n){var o=$(this);$(".popover.in").prev().each(function(p){var q=$(this);if(!q.is(o)){q.scope().cancel();q.popover("hide")}})})};d.uiConfig={calendar:angular.extend({editable:false,header:{left:"",center:"",right:"title"},firstDay:1,dayClick:d.alertEventOnClick,eventClick:d.eventOnClick,eventRender:d.eventRender,eventAfterAllRender:function(){h(function(){$("#activiteCalendar").fullCalendar("gotoDate",moment(c.currentActivite.mois).add("days",15).toDate());$("#activiteCalendar").find(".fc-content").css("overflow","visible")})}},jQuery.fullCalendar)};d.save=function(m){var n=angular.copy(d.$parent.currentActivite);if(n.etat>1){return}var j=(!n.etat||n.etat==-1)?true:false;n.activite=$.map(m,function(p,o){return{jour:p.start,type:p.data.type,information:p.data.information,heuresSup:p.data.heuresSup,heuresAstreinte:p.data.heuresAstreinte,heuresNuit:p.data.heuresNuit,heuresInt:p.data.heuresInt,duree:p.data.duree}});var l=[];function k(s,o){if(typeof o=="undefined"){o=1}var q=true;for(var r=0,p=l.length;r<p;r++){if(l[r].type==s){q=false;l[r].nb+=o}}if(q){l.push({type:s,nb:o})}}i.save(n,j).then(function(v){if(v.success===true){d.successOperation="Activité enregistrée";c.error="";n.etat=1;n.user=d.$parent.currentActivite.user;var u,t=0,p=0,r=0,s=0;for(var q=0,o=n.activite.length;q<o;q++){u=n.activite[q];if(u.type!="WK"){k(u.type,u.duree==0?1:0.5);t+=u.heuresSup;p+=u.heuresAstreinte;r+=u.heuresNuit;s+=u.heuresInt}}delete n.activite;for(var q=0,o=l.length;q<o;q++){u=l[q];n[u.type]=u.nb}n.heuresSup=t;n.heuresAstreinte=p;n.heuresNuit=r;n.heuresInt=s;f.close(n)}})}}}).call(app.controllerProvider);