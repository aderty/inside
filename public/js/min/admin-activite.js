"use strict";(function(){function n(n,t,i,r,u,f,e,o,s){function c(n){return n.format("d")!=0&&n.format("d")!=6}var h=(new Date).getFullYear();n.lstAnnees=[h,h-1,h-2];n.lstMois=[];n.lstMois.push.apply(n.lstMois,jQuery.fullCalendar.monthNames);n.lstMois.splice(0,0,"Tous");n.selection={annee:h,mois:n.lstMois[(new Date).getMonth()+1]};n.$on("search",function(t,i){i.searcher=="admin-activite"&&(n.tableParamsActivite.$params.filter=i.search,n.tableParamsSansActivite.$params.filter=i.search)});t.tableParamsActivite=new e({page:1,count:10,sorting:{mois:"asc"}},{getData:function(i,r){var u=angular.copy(n.selection);u.mois=n.lstMois.indexOf(u.mois);s.list(u).then(function(n){t.activites=o(n,r);i.resolve(t.activites)})}});t.tableParamsSansActivite=new e({page:1,count:10,sorting:{mois:"asc"}},{getData:function(i,r){var u=angular.copy(n.selection);u.mois=n.lstMois.indexOf(u.mois);s.listSans(u).then(function(n){t.sansActivites=o(n,r);i.resolve(t.sansActivites)})}});n.$watch("selection",function(i){var r=angular.copy(i);r.mois=n.lstMois.indexOf(i.mois);t.tableParamsActivite.reload();t.tableParamsSansActivite.reload()},!0);n.isEditable=function(){return!0};n.valider=function(n){var r=angular.copy(n),u=i.messageBox("Validation d'un mois d'activité","Etes-vous sûr de valider l'activité de "+r.user.prenom+" du mois de "+moment(r.mois).format("MMMM YYYY")+" ?",[{label:"Oui",result:"yes",cssClass:"btn-primary"},{label:"Non",result:"no"}]);u.open().then(function(i){i==="yes"&&(r.etat=2,s.updateEtat(r).then(function(i){i.success&&(n.etat=r.etat,t.infos.nbActivitesVal--)}))})};n.opts={backdrop:!0,keyboard:!0,backdropClick:!0,template:$.trim($("#showActiviteTmpl").html()),controller:"DialogShowActivite"};n.visualiser=function(r){n.currentActivite=angular.copy(r);s.get(n.currentActivite).then(function(r){var u,f,e;if(t.error="",n.eventSources=null,n.activiteUser=[],r.activite.length>0)for(u=0,f=r.activite.length;u<f;u++)n.activiteUser.push({title:r.activite[u].type,start:r.activite[u].jour.date,data:r.activite[u]});n.eventSources||(n.eventSources=[n.activiteUser]);t.currentActivite=n.currentActivite;t.eventSources=n.eventSources;e=i.dialog(n.opts);e.open().then(function(n){n})})};n["delete"]=function(n){var r=angular.copy(n),u=i.messageBox("Suppression d'un mois d'activité","Etes-vous sûr de supprimer l'activité de "+r.user.prenom+" du mois de "+moment(r.mois).format("MMMM YYYY")+" ?",[{label:"Oui",result:"yes",cssClass:"btn-primary"},{label:"Non",result:"no"}]);u.open().then(function(i){i==="yes"&&s.remove(r).then(function(i){if(i.success){var r=t.activites.indexOf(n);t.activites.splice(r,1);t.infos.nbActivitesVal--}})})};n.create=function(r){t.currentActivite=angular.copy(r);t.currentActivite.mois.setHours(12);n.start=t.currentActivite.mois;n.start.setHours(0);s.get(t.currentActivite).then(function(u){function a(t,i){var e,r,u;l=!0;e=!0;c(t)&&!i&&(r=angular.copy(o),r.start=!0,r.fin.date.getMonth()<=t.month()&&r.fin.date.getDate()<=t.date()&&(r.end=!0),r.end||r.debut.type!=0?r.end||r.debut.type!=1?r.debut.type==0&&r.end&&r.fin.type==0?(r.duree=1,u=new Date(t.toDate()),u.setHours(8),n.events.push({title:f("motifCongesShort")(r.type),start:u,data:r,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}),u=new Date(t.toDate()),u.setHours(12),n.conges.length>0&&n.conges[0].fin.date.getMonth()==t.month()&&n.conges[0].fin.date.getDate()<t.date()&&n.events.push({title:"Journée travaillée",allDay:!1,start:u,data:{type:"JT1",duree:2,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}}),e=!1):r.debut.type==1&&r.end&&r.fin.type==1?(r.duree=2,u=new Date(t.toDate()),u.setHours(8),s.fin.date.getMonth()==t.month()&&r.fin.date.getDate()<t.date()&&n.events.push({title:"Journée travaillée",allDay:!1,start:u,data:{type:"JT1",duree:1,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}}),u=new Date(t.toDate()),u.setHours(12),n.events.push({title:f("motifCongesShort")(r.type),start:u,data:r,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}),n.indexEvents[t.date()]=n.events.length-1,e=!1):r.debut.type==0&&r.end&&r.fin.type==1&&(r.duree=0):(r.duree=2,u=new Date(t.toDate()),u.setHours(8),s.fin.date.getMonth()==t.month()&&r.fin.date.getDate()<t.date()&&n.events.push({title:"Journée travaillée",allDay:!1,start:u,data:{type:"JT1",duree:1,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}}),u=new Date(t.toDate()),u.setHours(12),n.events.push({title:f("motifCongesShort")(r.type),start:u,data:r,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}),n.indexEvents[t.date()]=n.events.length-1,e=!1):r.duree=0,e&&(r.heuresSup=0,r.heuresAstreinte=0,r.heuresNuit=0,r.heuresInt=0,n.events.push({title:f("motifCongesShort")(r.type),start:new Date(t.toDate()),data:r}),n.indexEvents[t.date()]=n.events.length-1));s=angular.copy(o);o=n.conges.shift()}function b(t){var i=angular.copy(s),u=!0,r;i.fin.date.getMonth()<=t.month()&&i.fin.date.getDate()<=t.date()&&(i.end=!0);i.end||(i.duree=0);i.end&&i.fin.type==0&&(i.duree=1,r=new Date(t.toDate()),r.setHours(8),i.heuresSup=0,i.heuresAstreinte=0,i.heuresNuit=0,i.heuresInt=0,n.events.push({title:f("motifCongesShort")(i.type),start:r,data:i}),n.indexEvents[t.date()]=n.events.length-1,r=new Date(t.toDate()),r.setHours(12),o&&o.fin.date.getMonth()==t.month()&&o.fin.date.getDate()<t.date()&&n.events.push({title:"Journée travaillée",allDay:!1,start:r,data:{type:"JT1",duree:2,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}}),u=!1);i.end&&i.fin.type==1&&(i.duree=0);u&&(i.duree=0,i.heuresSup=0,i.heuresAstreinte=0,i.heuresNuit=0,i.heuresInt=0,n.events.push({title:f("motifCongesShort")(i.type),start:new Date(t.toDate()),data:i}),n.indexEvents[t.date()]=n.events.length-1)}function v(){l=!1}function k(t){c(t)?n.events.push({title:"Journée travaillée",start:new Date(t.toDate()),data:{type:"JT1",duree:0,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}}):n.events.push({title:"Weekend",start:new Date(t.toDate()),data:{type:"WK",duree:0,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}});n.indexEvents[t.date()]=n.events.length-1}var h,y,w;if(n.indexEvents=[],t.error="",n.activite=u,n.eventSources=null,n.activiteUser=[],n.events=[],n.activite.etat>0&&n.activite.activite.length>0)for(h=0,y=n.activite.activite.length;h<y;h++)n.events.push({title:n.activite.activite[h].type,start:n.activite.activite[h].jour.date,data:n.activite.activite[h]}),n.indexEvents[n.activite.activite[h].jour.date]=n.events.length-1;else{n.conges=n.activite.activite;var o=n.conges.shift(),s,p=!0,l=!1,e=new moment(n.start);if(e.date()!=1)while(e.date()!=1)o&&o.debut.date.getMonth()==e.month()&&o.debut.date.getDate()==e.date()&&a(e,!0),l&&s&&s.fin.date<=e.toDate()&&v(e),e=e.add("days",1);while(e.date()!=1||p)p=!1,l&&c(e)&&b(e),o&&o.debut.date.getMonth()==e.month()&&o.debut.date.getDate()==e.date()&&a(e),l&&s&&s.fin.date.getMonth()<=e.month()&&s.fin.date.getDate()<=e.date()&&v(e),typeof n.indexEvents[e.date()]=="undefined"&&k(e),e=e.add("days",1)}n.eventSources||(n.eventSources=[n.events]);t.eventSources=n.eventSources;w=i.dialog(n.opts);w.open().then(function(n){if(n){var i=t.activites.indexOf(r);t.sansActivites.splice(i,1);t.infos.nbActivitesVal++;t.activites.push(n)}})})}}function t(n,t,i,r,u,f){t.error="";n.user=n.$parent.currentActivite.user;n.eventSources=n.$parent.eventSources;n.uiConfig=n.$parent.uiConfig;n.close=function(){t.error="";u.close()};var e=(new Date).getFullYear();n.activiteUser=[];n.alertEventOnClick=function(t){n.$apply(function(){n.eventSelectionne=new moment(t).format("dddd D MMMM YYYY")})};n.eventOnClick=function(t){n.$apply(function(){n.currentEvent=t.data;n.eventSelectionne=new moment(t.start).format("dddd D MMMM YYYY")})};n.eventRender=function(i){function f(t){for(var i=0,r=n.eventSources[0].length;i<r;i++)if(n.eventSources[0][i].start==t)return i;return-1}var u=n.$new(!0);return angular.extend(u,i),u.typeActivite=t.typeActivite,u.typeActiviteJour=t.typeActivite,u.valid=function(){var r,t,i;(u.error=null,$("[rel=popover]").popover("hide"),r=u.savedEvent.duree,this.data.duree!=r)&&(this.data.duree==1?(t=new Date(this.start),t.setHours(16),this.start.setHours(8),this.allDay=!1,n.isUpdating=!0,i=f(this.start),n.eventSources[0].splice(i+1,0,{title:"Ap. midi",start:t,allDay:!1,data:{type:this.data.type,jour:t,duree:2}}),n.activiteCalendar.fullCalendar("refetchEvents")):this.data.duree==2?(t=new Date(this.start),t.setHours(8),this.start.setHours(16),this.allDay=!1,n.isUpdating=!0,i=f(this.start),n.eventSources[0].splice(i,0,{title:"Matin",start:t,allDay:!1,data:{type:this.data.type,jour:t,duree:1}}),n.activiteCalendar.fullCalendar("refetchEvents")):this.data.duree==0&&r==1?(this.allDay=!0,n.isUpdating=!0,i=f(this.start),this.start.setHours(0),n.eventSources[0].splice(i+1,1),n.activiteCalendar.fullCalendar("refetchEvents")):this.data.duree==0&&r==2&&(this.allDay=!0,n.isUpdating=!0,i=f(this.start),this.start.setHours(0),n.eventSources[0].splice(i-1,1),n.activiteCalendar.fullCalendar("refetchEvents")))},u.cancel=function(){u.error=null;$.extend(u.data,u.savedEvent);$("[rel=popover]").popover("hide")},u.infos=function(n){return n.duree==2?"Ap. midi":n.duree==1?"Matin":void 0},u.hasHeuresAstreinte=function(){return!0},u.$watch("data.type",function(n,t){t&&n=="JT1"&&(t=="WK"||t=="JF")&&(u.data.heuresAstreinte=7.5)}),r($.trim($("#eventTmpl").html()))(u).attr("rel","popover").popover({html:!0,content:function(){return u.savedEvent=angular.copy(u.data),r($.trim($("#popoverEventTmpl").html()))(u)}}).click(function(){var n=$(this);$(".popover.in").prev().each(function(){var t=$(this);t.is(n)||(t.scope().cancel(),t.popover("hide"))})})};n.uiConfig={calendar:angular.extend({editable:!1,header:{left:"",center:"",right:"title"},firstDay:1,dayClick:n.alertEventOnClick,eventClick:n.eventOnClick,eventRender:n.eventRender,eventAfterAllRender:function(){i(function(){$("#activiteCalendar").fullCalendar("gotoDate",moment(t.currentActivite.mois).add("days",15).toDate());$("#activiteCalendar").find(".fc-content").css("overflow","visible")})}},jQuery.fullCalendar)};n.save=function(i){function s(n,t){var r,i,u;for(typeof t=="undefined"&&(t=1),r=!0,i=0,u=e.length;i<u;i++)e[i].type==n&&(r=!1,e[i].nb+=t);r&&e.push({type:n,nb:t})}var r=angular.copy(n.$parent.currentActivite),o,e;r.etat>1||(o=!r.etat||r.etat==-1?!0:!1,r.activite=$.map(i,function(n){return{jour:n.start,type:n.data.type,information:n.data.information,heuresSup:n.data.heuresSup,heuresAstreinte:n.data.heuresAstreinte,heuresNuit:n.data.heuresNuit,heuresInt:n.data.heuresInt,duree:n.data.duree}}),e=[],f.save(r,o).then(function(i){var o,h;if(i.success===!0){n.successOperation="Activité enregistrée";t.error="";r.etat=1;r.user=n.$parent.currentActivite.user;var f,c=0,l=0,a=0,v=0;for(o=0,h=r.activite.length;o<h;o++)f=r.activite[o],f.type!="WK"&&(s(f.type,f.duree==0?1:.5),c+=f.heuresSup,l+=f.heuresAstreinte,a+=f.heuresNuit,v+=f.heuresInt);for(delete r.activite,o=0,h=e.length;o<h;o++)f=e[o],r[f.type]=f.nb;r.heuresSup=c;r.heuresAstreinte=l;r.heuresNuit=a;r.heuresInt=v;u.close(r)}}))}}this.register("ActiviteAdmin",["$scope","$rootScope","$dialog","$timeout","$compile","$filter","ngTableParams","ngTableFilter","ActiviteAdminService",n]);this.register("DialogShowActivite",["$scope","$rootScope","$timeout","$compile","dialog","ActiviteAdminService",t])}).call(app.controllerProvider);