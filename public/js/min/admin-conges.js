"use strict";(function(){this.register("CongesAdmin",["$scope","$rootScope","$dialog","CongesAdminService","UsersService",c]);this.register("DialogConges",["$scope","$rootScope","dialog",a]);this.register("DialogAideConges",["$scope","dialog",d]);this.register("CongesAdminGrid",["$scope","$rootScope","$timeout","$filter","ngTableParams","ngTableFilter","CongesAdminService",b]);function c(f,e,g,i,j){f.edition=0;f.mode="";f.lblMode="";f.currentConges={};f.currentCongesSaved=null;f.showMatricule=true;f.dateOptionsDebut={dateFormat:"dd/mm/yy",changeYear:true,changeMonth:true,yearRange:"-2Y:+1Y"};f.dateOptionsFin={dateFormat:"dd/mm/yy",changeYear:true,changeMonth:true,yearRange:"-2Y:+1Y"};f.$watch("currentConges.debut.date",function(k){f.dateOptionsFin.minDate=k});f.accepter=function(o){f.currentConges=o;if(f.currentConges.etat==2||f.currentConges.etat==3){return}var k=angular.copy(f.currentConges);k.etat=2;var n="Etes-vous sûr de vouloir valider la demande d'absence ?";var m=[{label:"Oui",result:"yes",cssClass:"btn-primary"},{label:"Non",result:"no"}];var l=g.messageBox("Validation d'une absence",n,m);l.open().then(function(p){if(p==="yes"){i.updateEtat(k,false).then(function(r){e.error=null;e.infos.nbCongesVal--;f.currentConges.etat=2;var q=e.congesAvalider.indexOf(o);if(q>-1){e.congesAvalider.splice(q,1)}else{q=e.congesRefuser.indexOf(o);if(q>-1){e.congesRefuser.splice(q,1)}}e.congesValider.push(o)})}})};f.opts={backdrop:true,keyboard:true,backdropClick:true,template:$.trim($("#refusTmpl").html()),controller:"DialogConges"};f.refuser=function(m){f.currentConges=m;if(f.currentConges.etat==3){return}var k=angular.copy(f.currentConges);k.etat=3;e.dialogModel=k;var l=g.dialog(f.opts);l.open().then(function(n){if(n==="yes"){i.updateEtat(k,false).then(function(p){e.error=null;e.infos.nbCongesVal--;f.currentConges.etat=3;var o=e.congesAvalider.indexOf(m);if(o>-1){e.congesAvalider.splice(o,1)}else{o=e.congesValider.indexOf(m);if(o>-1){e.congesValider.splice(o,1)}}e.congesRefuser.push(m)})}})};f.create=function(){e.error=null;f.editConges.$setPristine();f.currentConges={typeuser:1,etat:2,debut:{type:0},fin:{type:1}};f.edition=1;f.mode="Création";f.lblMode="Nouvelle absence de régulation"};f.cancel=function(){e.error=null;f.edition=0;$.extend(f.currentConges,f.currentCongesSaved)};f.edit=function(k){e.error=null;f.currentConges=k;f.editConges.$setPristine();f.currentCongesSaved=angular.copy(f.currentConges);f.edition=2;f.mode="Edition";f.lblMode="Modification d'une absence";f.dateOptionsFin.minDate=f.currentConges.debut.date};f["delete"]=function(m){var l=[{label:"Oui",result:"yes",cssClass:"btn-primary"},{label:"Non",result:"no"}];var k=g.messageBox("Suppression d'une absence","Etes-vous sûr de supprimer la demande d'absence ?",l);k.open().then(function(n){if(n==="yes"){i.remove(m).then(function(p){var o=e.congesAvalider.indexOf(m);if(o>-1){e.congesAvalider.splice(o,1)}else{o=e.congesValider.indexOf(m);if(o>-1){e.congesValider.splice(o,1)}else{o=e.congesRefuser.indexOf(m);if(o>-1){e.congesRefuser.splice(o,1)}}}})}})};f.isEditable=function(k){return k.etat!=3};f.isUnchanged=function(k){f.haschanged=angular.equals(k,f.currentCongesSaved);return};f.save=function(l){var k=angular.copy(l);i.save(k,f.edition==1).then(function(m){e.error=null;if(l.typeuser==2){l.user=k.user}if(m.id){l.id=m.id}if(m.duree){l.duree=m.duree}if(f.edition==1){e.congesValider.push(l)}f.edition=0;f.currentConges=null})};f.selectUserOptions={placeholder:"Rechercher un utilisateur",minimumInputLength:1,query:function(k){var l=isNaN(k.term)?"text":"id";e.$apply(function(){j.search({type:l,search:k.term}).then(function(m){k.callback({more:false,results:m})})})},data:[{id:2,nom:"tous",prenom:""}],initSelection:function(l,m,k){},formatResult:h,formatSelection:h,dropdownCssClass:"bigdrop",escapeMarkup:function(k){return k}};function h(k){return k.nom.toLowerCase()+" "+k.prenom}f.showAide=function(){var k=g.dialog({backdrop:true,keyboard:true,backdropClick:true,templateUrl:"/templates/aide-conges.html?v="+config.version,controller:"DialogAideConges"});k.open()}}function a(f,e,g){f.close=function(h){g.close(h)}}function d(e,f){e.close=function(){f.close()}}function b(f,e,h,j,g,l,k){f.filterOptions={filterText:"",useExternalFilter:false};f.$on("search",function(m,n){if(n.searcher=="admin-conges"){f.tableParamsCongesAValider.$params.filter=n.search;f.tableParamsValider.$params.filter=n.search;f.tableParamsRefuser.$params.filter=n.search}});f.pagingOptions={pageSizes:[25,50,100],pageSize:50,totalServerItems:0,currentPage:1};f.etatOptions={type:1};var i=f;e.tableParamsCongesAValider=new g({page:1,count:100,sorting:{"debut.date":"asc"}},{getData:function(m,n){k.list({etat:1}).then(function(o){e.congesAvalider=l(o,n);m.resolve(e.congesAvalider)})}});e.tableParamsValider=new g({page:1,count:100,sorting:{"debut.date":"asc"}},{getData:function(m,n){k.list({etat:2}).then(function(o){e.congesValider=l(o,n);m.resolve(e.congesValider)})}});e.tableParamsRefuser=new g({page:1,count:100,sorting:{"debut.date":"asc"}},{getData:function(m,n){k.list({etat:3}).then(function(o){e.congesRefuser=l(o,n);m.resolve(e.congesRefuser)})}});f.$on("ngGridEventColumns",function(m){setTimeout(function(){$(".matriculeCell>span").tooltip({container:"body"})},250)})}}).call(app.controllerProvider);