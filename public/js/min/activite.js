"use strict";(function(){function t(t,i,r,u,f,e,o){function s(n){return n.format("d")!=0&&n.format("d")!=6}function p(n,i){var u,r,f;for(typeof i=="undefined"&&(i=1),u=!0,r=0,f=t.typeActivitePerso.length;r<f;r++)t.typeActivitePerso[r].id==n&&(!t.typeActivitePerso[r].libelle,u=!1,t.typeActivitePerso[r].nb+=i)}var h=new Date,w=h.getDate(),a=h.getMonth(),v=h.getFullYear(),c,l,y;t.user=r.get({id:0},function(){});t.isDirty=!1;t.eventSelectionne=null;t.events=[];t.successOperation="";t.typeActivitePerso=[];t.refresh=function(){t.isDirty=!1;t.activiteCalendar.fullCalendar("refetchEvents")};t.$watch("events",function(n){c&&clearTimeout(c);c=setTimeout(function(){t.$apply(function(){var r,o=0,h=0,c=0,l=0,a=0,v=0,u,f;for(t.typeActivitePerso=angular.copy(i.typeActivite),u=0,f=t.typeActivitePerso.length;u<f;u++)t.typeActivitePerso[u].libelle=e("motifCongesShort")(t.typeActivitePerso[u].id,i.typeActivite),t.typeActivitePerso[u].nb=0;for(u=0,f=n.length;u<f;u++)r=n[u],r.data.type!="WK"&&r.data.type!="JF"&&(p(r.data.type,r.data.duree==0?1:.5),o+=r.data.heuresSup||0,h+=r.data.heuresAstreinte||0,c+=r.data.heuresNuit||0,l+=r.data.heuresInt||0,v++,s(moment(r.start))&&a++);t.heuresSup=o;t.heuresAstreinte=h;t.heuresNuit=c;t.heuresInt=l;t.joursOuvres=a;t.joursTotal=v})},100)},!0);t.load=function(n){t.eventSelectionne=null;u.list({start:t.start,end:t.end}).then(function(i){function c(n,i){var c,r,o;h=!0;c=!0;s(n)&&!i&&(r=angular.copy(u),r.start=!0,r.fin.date.getMonth()<=n.month()&&r.fin.date.getDate()<=n.date()&&(r.end=!0),r.end||r.debut.type!=0?r.end||r.debut.type!=1?r.debut.type==0&&r.end&&r.fin.type==0?(r.duree=1,o=new Date(n.toDate()),o.setHours(8),t.events.push({title:e("motifCongesShort")(r.type),start:o,data:r,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}),o=new Date(n.toDate()),o.setHours(12),t.conges.length>0&&t.conges[0].fin.date.getMonth()==n.month()&&t.conges[0].fin.date.getDate()<n.date()&&t.events.push({title:"Journée travaillée",allDay:!1,start:o,data:{type:"JT1",duree:2,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}}),c=!1):r.debut.type==1&&r.end&&r.fin.type==1?(r.duree=2,o=new Date(n.toDate()),o.setHours(8),f.fin.date.getMonth()==n.month()&&r.fin.date.getDate()<n.date()&&t.events.push({title:"Journée travaillée",allDay:!1,start:o,data:{type:"JT1",duree:1,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}}),o=new Date(n.toDate()),o.setHours(12),t.events.push({title:e("motifCongesShort")(r.type),start:o,data:r,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}),t.indexEvents[n.date()]=t.events.length-1,c=!1):r.debut.type==0&&r.end&&r.fin.type==1&&(r.duree=0):(r.duree=2,o=new Date(n.toDate()),o.setHours(8),f.fin.date.getMonth()==n.month()&&r.fin.date.getDate()<n.date()&&t.events.push({title:"Journée travaillée",allDay:!1,start:o,data:{type:"JT1",duree:1,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}}),o=new Date(n.toDate()),o.setHours(12),t.events.push({title:e("motifCongesShort")(r.type),start:o,data:r,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}),t.indexEvents[n.date()]=t.events.length-1,c=!1):r.duree=0,c&&(r.heuresSup=0,r.heuresAstreinte=0,r.heuresNuit=0,r.heuresInt=0,t.events.push({title:e("motifCongesShort")(r.type),start:new Date(n.toDate()),data:r}),t.indexEvents[n.date()]=t.events.length-1));f=angular.copy(u);u=t.conges.shift()}function y(n){var i=angular.copy(f),o=!0,r;i.fin.date.getMonth()<=n.month()&&i.fin.date.getDate()<=n.date()&&(i.end=!0);i.end||(i.duree=0);i.end&&i.fin.type==0&&(i.duree=1,r=new Date(n.toDate()),r.setHours(8),i.heuresSup=0,i.heuresAstreinte=0,i.heuresNuit=0,i.heuresInt=0,t.events.push({title:e("motifCongesShort")(i.type),start:r,data:i}),t.indexEvents[n.date()]=t.events.length-1,r=new Date(n.toDate()),r.setHours(12),u&&u.fin.date.getMonth()==n.month()&&u.fin.date.getDate()<n.date()&&t.events.push({title:"Journée travaillée",allDay:!1,start:r,data:{type:"JT1",duree:2,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}}),o=!1);i.end&&i.fin.type==1&&(i.duree=0);o&&(i.heuresSup=0,i.heuresAstreinte=0,i.heuresNuit=0,i.heuresInt=0,t.events.push({title:e("motifCongesShort")(i.type),start:new Date(n.toDate()),data:i}),t.indexEvents[n.date()]=t.events.length-1)}function l(){h=!1}function p(n){s(n)?t.events.push({title:"Journée travaillée",start:new Date(n.toDate()),data:{type:"JT1",duree:0,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}}):t.events.push({title:"Weekend",start:new Date(n.toDate()),data:{type:"WK",duree:0,heuresSup:0,heuresAstreinte:0,heuresNuit:0,heuresInt:0}});t.indexEvents[n.date()]=t.events.length-1}var o,a;if(t.activite=i,t.indexEvents=[],t.events=[],t.successOperation="",t.activite.etat>0&&t.activite.activite.length>0)for(o=0,a=t.activite.activite.length;o<a;o++)t.events.push({title:t.activite.activite[o].type,start:t.activite.activite[o].jour.date,data:t.activite.activite[o]}),t.indexEvents[t.activite.activite[o].jour.date]=t.events.length-1;else{t.conges=t.activite.activite;var u=t.conges.shift(),f,v=!0,h=!1,r=new moment(t.start);if(r.date()!=1)while(r.date()!=1)u&&u.debut.date.getMonth()==r.month()&&u.debut.date.getDate()==r.date()&&c(r,!0),h&&f&&f.fin.date<=r.toDate()&&l(r),r=r.add("days",1);while(r.date()!=1||v)v=!1,h&&s(r)&&y(r),u&&u.debut.date.getMonth()==r.month()&&u.debut.date.getDate()==r.date()&&c(r),h&&f&&f.fin.date.getMonth()<=r.month()&&f.fin.date.getDate()<=r.date()&&l(r),typeof t.indexEvents[r.date()]=="undefined"&&p(r),r=r.add("days",1)}n&&n(t.events)})};t.eventsA=[];t.eventsF=function(n,i,r){var u=new Date(n).getTime()/1e3,e=new Date(i).getTime()/1e3,o=new Date(n).getMonth();t.start=n;t.end=i;t.isUpdating?(t.isUpdating=!1,r(t.events)):f(function(){t.load(r)})};t.eventRender=function(r){function f(n){for(var i=0,r=t.events.length;i<r;i++)if(t.events[i].start==n)return i;return-1}if(y>l&&r.data.type=="JT1")return!1;var u=t.$new(!0);return angular.extend(u,r),u.typeActivite=i.typeActivite,u.typeActiviteJour=r.data.type=="JF"?i.typeActiviteAstreinte:s(moment(r.start))?i.typeActiviteTravaille:i.typeActiviteWeekend,u.cssConges=i.cssConges,u.valid=function(){var e,i,r;(u.error=null,n=!0,t.isDirty=!0,$("[rel=popover]").popover("hide"),e=u.savedEvent.duree,this.data.duree!=e)&&(this.data.duree==1?(i=new Date(this.start),i.setHours(16),this.start.setHours(8),this.allDay=!1,t.isUpdating=!0,r=f(this.start),t.events.splice(r+1,0,{title:"Ap. midi",start:i,allDay:!1,data:{type:this.data.type,jour:i,duree:2}}),t.activiteCalendar.fullCalendar("refetchEvents")):this.data.duree==2?(i=new Date(this.start),i.setHours(8),this.start.setHours(16),this.allDay=!1,t.isUpdating=!0,r=f(this.start),t.events.splice(r,0,{title:"Matin",start:i,allDay:!1,data:{type:this.data.type,jour:i,duree:1}}),t.activiteCalendar.fullCalendar("refetchEvents")):this.data.duree==0&&e==1?(this.allDay=!0,t.isUpdating=!0,r=f(this.start),this.start.setHours(0),t.events.splice(r+1,1),t.activiteCalendar.fullCalendar("refetchEvents")):this.data.duree==0&&e==2&&(this.allDay=!0,t.isUpdating=!0,r=f(this.start),this.start.setHours(0),t.events.splice(r-1,1),t.activiteCalendar.fullCalendar("refetchEvents")))},u.cancel=function(){u.error=null;$.extend(u.data,u.savedEvent);$("[rel=popover]").popover("hide")},u.infos=function(n){return n.duree==2?"Ap. midi":n.duree==1?"Matin":void 0},u.hasHeuresAstreinte=function(n){return n.heuresAstreinte>0||!s(moment(start))&&(n.type=="JT1"||n.type=="JT2"||n.type=="JT3")||n.type=="JF"},o($.trim($("#eventTmpl").html()))(u).attr("rel","popover").popover({html:!0,content:function(){return u.data.type!="FOR"&&u.data.type!="INT"&&u.data.type!="JT1"&&u.data.type!="JT2"&&u.data.type!="JT3"&&u.data.type!="JF"&&u.data.type!="WK"?!1:(u.savedEvent=angular.copy(u.data),o($.trim($("#popoverEventTmpl").html()))(u))}}).click(function(){var n=$(this);$(".popover.in").prev().each(function(){var t=$(this);t.is(n)||(t.scope().cancel(),t.popover("hide"))})})};t.alertEventOnClick=function(n){t.$apply(function(){t.eventSelectionne=new moment(n).format("dddd D MMMM YYYY")})};t.eventOnClick=function(n){t.$apply(function(){t.currentEvent=n.data;t.eventSelectionne=new moment(n.start).format("dddd D MMMM YYYY")})};t.closeSuccess=function(){t.successOperation=""};t.save=function(i){var r=angular.copy(t.activite),f;r.etat>1||(f=r.etat==-1?!0:!1,r.activite=$.map(i,function(n){return{jour:n.start,type:n.data.type,information:n.data.information,heuresSup:n.data.heuresSup,heuresAstreinte:n.data.heuresAstreinte,heuresNuit:n.data.heuresNuit,heuresInt:n.data.heuresInt}}),u.save(r,f).then(function(i){i.success===!0&&(n=!1,t.isDirty=!1,t.successOperation="Activité enregistrée")}))};t.eventSources=[t.events,t.eventsF];t.alertOnDrop=function(n,i){return!1};t.alertOnResize=function(n,i,r){t.$apply(function(){t.alertMessage="Event Resized to make dayDelta "+r})};t.addRemoveEventSource=function(n,t){var i=0;angular.forEach(n,function(r,u){n[u]===t&&(n.splice(u,1),i=1)});i===0&&n.push(t)};t.addEvent=function(){t.events.push({title:"Open Sesame",start:new Date(v,a,28),end:new Date(v,a,29),className:["openSesame"]})};t.remove=function(n){t.events.splice(n,1)};t.changeView=function(n){t.activiteCalendar.fullCalendar("changeView",n)};l=new Date((new Date).getFullYear(),(new Date).getMonth()+3,1);t.uiConfig={calendar:angular.extend({editable:!1,header:{right:"today prev,next"},viewDisplay:function(n){t.start=n.start;t.end=n.end;y=n.start;t.future=n.start>l?!0:moment().diff(moment(n.start),"months",!0)>3?!0:!1},firstDay:1,dayClick:t.alertEventOnClick,eventDrop:t.alertOnDrop,eventResize:t.alertOnResize,eventClick:t.eventOnClick,eventRender:t.eventRender,eventAfterAllRender:function(){f(function(){})}},jQuery.fullCalendar)}}var n=!1;window.onbeforeunload=function(){if(n)return"Si vous ne cliquez pas sur le bouton 'Sauvegarder', toutes les modifications effectuées seront perdues."};this.register("ActiviteMain",["$scope","$rootScope","UsersService","ActiviteService","$timeout","$filter","$compile",t])}).call(app.controllerProvider);