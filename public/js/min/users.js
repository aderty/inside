"use strict";(function(){this.register("UsersMain",["$scope","$rootScope","$dialog","UsersService",a]);this.register("UsersGrid",["$scope","$rootScope","$filter","ngTableParams","ngTableFilter","UsersService",c]);this.register("DialogHistory",["$scope","$rootScope","$filter","ngTableParams","dialog","HistoryService",b]);function a(e,d,f,h){if(!d.nextId){d.nextId=max}e.edition=0;e.mode="";e.lblMode="";e.currentUserSaved=null;e.create=function(){e.error=null;e.editUser.$setPristine();document.getElementById("password").value="";document.getElementById("confirm_password").value="";e.currentUser={id:d.nextId,role:1,admin:{id:0,nom:"Admin"},hasRtt:true,cp:0,cp_ant:0,rtt:0};e.edition=1;e.mode="Création";e.lblMode="Création d'un nouvel utilisateur"};e.cancel=function(){e.error=null;e.edition=0;$.extend(e.currentUser,e.currentUserSaved)};e.edit=function(i){e.error=null;e.currentUser=i;e.editUser.$setPristine();e.currentUserSaved=angular.copy(e.currentUser);e.edition=2;e.mode="Edition";e.lblMode="Modification de "};e.histo=function(k){e.error=null;d.error="";d.currentUser=k;var i={backdrop:true,keyboard:true,backdropClick:true,templateUrl:"/templates/history.html",controller:"DialogHistory"};var j=f.dialog(i);j.open().then(function(l){if(l){}})};e["delete"]=function(k){var j=[{label:"Oui",result:"yes",cssClass:"btn-primary"},{label:"Non",result:"no"}];var i=f.messageBox("Suppression d'un utilisateur","Etes-vous sûr de supprimer "+k.prenom+" "+k.nom+"?",j);i.open().then(function(l){if(l==="yes"){h.remove(k,function(n){var m=d.users.indexOf(k);d.users.splice(m,1)})}})};e.isUnchanged=function(i){e.haschanged=angular.equals(i,e.currentUserSaved);return};e.save=function(i){var j=angular.copy(i);delete j.pwdtest;if(e.edition==1){j.create=true;d.nextId++}else{if(j.id!=e.currentUserSaved.id){j.lastId=e.currentUserSaved.id}}if(j.admin){j.admin=j.admin.id}h.save(j,function(l){if(l.error){e.error=l.error;return}e.error=null;e.edition=0;var k=d.users.indexOf(i);if(k==-1){d.users.push(i)}})};e.selectUserOptions={placeholder:"Rechercher un utilisateur",minimumInputLength:1,query:function(i){var j=isNaN(i.term)?"text":"id";d.$apply(function(){h.search({type:j,search:i.term}).then(function(k){i.callback({more:false,results:k})})})},initSelection:function(j,k,i){},formatResult:g,formatSelection:g,dropdownCssClass:"bigdrop",escapeMarkup:function(i){return i}};function g(i){return i.nom+" "+(i.prenom||"")}e.currentUser={}}function c(f,d,h,g,i,j){f.filterOptions={filterText:"",useExternalFilter:false};var e;f.$on("search",function(k,l){if(l.searcher=="users"){f.filterOptions={filterText:l.search,useExternalFilter:false};f.tableParamsUser.$params.filter=l.search}});f.pagingOptions={pageSizes:[25,50,100],pageSize:50,totalServerItems:0,currentPage:1};f.tableParamsUser=new g({page:1,count:10,sorting:{id:"asc"}},{getData:function(k,l){d.users=j.query(function(){for(var n=0,m=d.users.length;n<m;n++){d.users[n].dateNaissance=new Date(d.users[n].dateNaissance);if(typeof d.users[n].admin!="undefined"){d.users[n].admin={id:d.users[n].admin,nom:d.users[n].adminNom,prenom:d.users[n].adminPrenom};delete d.users[n].adminNom;delete d.users[n].adminPrenom}}d.users=i(d.users,l);k.resolve(d.users)})}});f.$watch("users",function(k){d.users=k},true)}function b(f,d,j,h,g,e){d.error="";d.history=null;var i;f.close=function(){d.error="";g.close()};f.tableParams=new h({page:1,count:5,sorting:{date:"desc"}},{counts:[5,10,25,50,100],getData:function(k,l){e.list(d.currentUser.id).then(function(m){d.history=ngTableFilter(m,l);k.resolve(d.history)})}})}}).call(app.controllerProvider);