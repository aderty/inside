"use strict";(function(){function n(n,t,i,r){function u(n){return n.nom.toLowerCase()+" "+(n.prenom||"")}t.nextId||(t.nextId=max);n.edition=0;n.mode="";n.lblMode="";n.currentUserSaved=null;n.create=function(){n.error=null;n.editUser.$setPristine();document.getElementById("password").value="";document.getElementById("confirm_password").value="";n.currentUser={id:t.nextId,role:1,admin:{id:0,nom:"Admin"},hasRtt:!0,cp:0,cp_ant:0,rtt:0};n.edition=1;n.mode="Création";n.lblMode="Création d'un nouvel utilisateur"};n.cancel=function(){n.error=null;n.edition=0;$.extend(n.currentUser,n.currentUserSaved)};n.edit=function(t){n.error=null;n.currentUser=t;n.editUser.$setPristine();n.currentUserSaved=angular.copy(n.currentUser);n.edition=2;n.mode="Edition";n.lblMode="Modification de "};n.histo=function(r){n.error=null;t.error="";t.currentUser=r;var u=i.dialog({backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"/templates/history.html",controller:"DialogHistory"});u.open().then(function(n){n})};n["delete"]=function(n){var u=i.messageBox("Suppression d'un utilisateur","Etes-vous sûr de supprimer "+n.prenom+" "+n.nom+"?",[{label:"Oui",result:"yes",cssClass:"btn-primary"},{label:"Non",result:"no"}]);u.open().then(function(i){i==="yes"&&r.remove(n,function(){var i=t.users.indexOf(n);t.users.splice(i,1)})})};n.isUnchanged=function(t){n.haschanged=angular.equals(t,n.currentUserSaved);return};n.save=function(i){var u=angular.copy(i);delete u.pwdtest;n.edition==1?(u.create=!0,t.nextId++):u.id!=n.currentUserSaved.id&&(u.lastId=n.currentUserSaved.id);u.admin&&(u.admin=u.admin.id);r.save(u,function(r){if(r.error){n.error=r.error;return}n.error=null;n.edition=0;var u=t.users.indexOf(i);u==-1&&t.users.push(i)})};n.selectUserOptions={placeholder:"Rechercher un utilisateur",minimumInputLength:1,query:function(n){var i=isNaN(n.term)?"text":"id";t.$apply(function(){r.search({type:i,search:n.term}).then(function(t){n.callback({more:!1,results:t})})})},initSelection:function(){},formatResult:u,formatSelection:u,dropdownCssClass:"bigdrop",escapeMarkup:function(n){return n}};n.currentUser={}}function t(n,t,i,r,u,f){n.filterOptions={filterText:"",useExternalFilter:!1};n.$on("search",function(t,i){i.searcher=="users"&&(n.filterOptions={filterText:i.search,useExternalFilter:!1},n.tableParamsUser.$params.filter=i.search)});n.pagingOptions={pageSizes:[25,50,100],pageSize:50,totalServerItems:0,currentPage:1};n.tableParamsUser=new r({page:1,count:10,sorting:{id:"asc"}},{getData:function(n,i){t.users=f.query(function(){for(var r=0,f=t.users.length;r<f;r++)t.users[r].dateNaissance=new Date(t.users[r].dateNaissance),typeof t.users[r].admin!="undefined"&&(t.users[r].admin={id:t.users[r].admin,nom:t.users[r].adminNom,prenom:t.users[r].adminPrenom},delete t.users[r].adminNom,delete t.users[r].adminPrenom);t.users=u(t.users,i);n.resolve(t.users)})}});n.$watch("users",function(n){t.users=n},!0)}function i(n,t,i,r,u,f){t.error="";t.history=null;n.close=function(){t.error="";u.close()};n.tableParams=new r({page:1,count:5,sorting:{date:"desc"}},{counts:[5,10,25,50,100],getData:function(n,i){f.list(t.currentUser.id).then(function(r){t.history=ngTableFilter(r,i);n.resolve(t.history)})}})}this.register("UsersMain",["$scope","$rootScope","$dialog","UsersService",n]);this.register("UsersGrid",["$scope","$rootScope","$filter","ngTableParams","ngTableFilter","UsersService",t]);this.register("DialogHistory",["$scope","$rootScope","$filter","ngTableParams","dialog","HistoryService",i])}).call(app.controllerProvider);